const FORMAT_DATA={"join_success":{"text":{"zh":"加入成功。","en":"Joined successfully."},"css":{"color":"green"},"message_class":null},"title":{"text":{"zh":"暮光原野","en":"Dark Wild"},"css":{},"message_class":null},"game_title":{"text":{"zh":"暮光原野","en":"Dark Wild"},"css":{},"message_class":null},"action_title":{"text":{"zh":"行动","en":"Actions"},"css":{},"message_class":null},"go_forward":{"text":{"zh":"前进","en":"Go forward"},"css":{},"message_class":null},"go_backward":{"text":{"zh":"后退","en":"Go backward"},"css":{},"message_class":null},"turn_left":{"text":{"zh":"左转","en":"Turn left"},"css":{},"message_class":null},"turn_right":{"text":{"zh":"右转","en":"Turn right"},"css":{},"message_class":null},"touch_front":{"text":{"zh":"向前摸","en":"Touch front"},"css":{},"message_class":null},"touch_ground":{"text":{"zh":"向下探","en":"Touch ground"},"css":{},"message_class":null},"attack":{"text":{"zh":"攻击","en":"attack"},"css":{},"message_class":null},"respawn":{"text":{"zh":"重生","en":"Respawn"},"css":{},"message_class":null},"name_tag":{"text":{"zh":"玩家名:","en":"Name:"},"css":{},"message_class":null},"health_tag":{"text":{"zh":"生命:","en":"Health:"},"css":{},"message_class":null},"coin_tag":{"text":{"zh":"金币:","en":"Coin:"},"css":{},"message_class":null},"tree":{"text":{"zh":"树","en":"tree"},"css":{},"message_class":null},"grass":{"text":{"zh":"草丛","en":"grass"},"css":{},"message_class":null},"barrier":{"text":{"zh":"屏障","en":"barrier"},"css":{},"message_class":null},"ice":{"text":{"zh":"冰","en":"ice"},"css":{},"message_class":null},"gold_block":{"text":{"zh":"金块","en":"gold block"},"css":{},"message_class":null},"girl":{"text":{"zh":"流浪女孩","en":"wandering girl"},"css":{},"message_class":null},"lava":{"text":{"zh":"岩浆","en":"lava"},"css":{},"message_class":null},"thorns":{"text":{"zh":"荆棘","en":"thorns"},"css":{},"message_class":null},"soft":{"text":{"zh":"软","en":"soft"},"css":{},"message_class":null},"hard":{"text":{"zh":"硬","en":"hard"},"css":{},"message_class":null},"dead_player":{"text":{"zh":"玩家已死。","en":"The player is dead."},"css":{"color":"red"},"message_class":null},"forward":{"text":{"zh":"前方","en":"forward"},"css":{},"message_class":null},"front":{"text":{"zh":"前方","en":"front"},"css":{},"message_class":null},"back":{"text":{"zh":"后方","en":"back"},"css":{},"message_class":null},"left":{"text":{"zh":"左方","en":"left"},"css":{},"message_class":null},"right":{"text":{"zh":"右方","en":"right"},"css":{},"message_class":null},"hand":{"text":{"zh":"手部","en":"hand"},"css":{},"message_class":null},"foot":{"text":{"zh":"脚部","en":"foot"},"css":{},"message_class":null},"go_successfully":{"text":{"zh":"成功地向{dir}走了一步。","en":"Go {dir} successfully."},"css":{},"message_class":null},"go_failed":{"text":{"zh":"你撞到了一个{hardness}物。","en":"You hit something {hardness}."},"css":{"color":"orange"},"message_class":null},"turn_successfully":{"text":{"zh":"转向{dir}。","en":"Turn {dir}."},"css":{"color":"#99ffff"},"message_class":null},"collect_coin":{"text":{"zh":"你捡到了{count}枚金币！","en":"You collected {count} coins!"},"css":{"color":"gold"},"message_class":null},"respawn_success":{"text":{"zh":"重生成功。","en":"Respawn successfully."},"css":{"color":"#99ff99"},"message_class":null},"respawn_failed":{"text":{"zh":"重生失败。原因:{reason}","en":"Respawn failed. Reason:{reason}"},"css":{"color":"red"},"message_class":null},"touch_front_something":{"text":{"zh":"你摸到了一个{hardness}的东西。","en":"You touched a {hardness} thing."},"css":{"color":"#ccccff"},"message_class":null},"touch_front_nothing":{"text":{"zh":"你什么也没摸到。","en":"You touched nothing."},"css":{"color":"#ccccff"},"message_class":null},"touch_ground_result":{"text":{"zh":"你摸了摸地面，{feeling}。","en":"You touched ground and {feeling}."},"css":{"color":"#ffffbb"},"message_class":null},"temp_normal":{"text":{"zh":"温度正常","en":"feel the temperture is normal"},"css":{},"message_class":null},"temp_feeling":{"text":{"zh":"感到{feeling}","en":"feel {feeling}"},"css":{},"message_class":null},"feeling_a_bit":{"text":{"zh":"有点{temp}","en":"a bit {temp}"},"css":{},"message_class":null},"feeling_none":{"text":{"zh":"挺{temp}的","en":"{temp}"},"css":{},"message_class":null},"feeling_very":{"text":{"zh":"很{temp}","en":"very {temp}"},"css":{},"message_class":null},"feeling_very_very":{"text":{"zh":"非常{temp}","en":"very very {temp}"},"css":{},"message_class":null},"feeling_super":{"text":{"zh":"极{temp}","en":"super {temp}"},"css":{},"message_class":null},"feeling_hell":{"text":{"zh":"地狱般的{temp}","en":"{temp} like in the hell"},"css":{},"message_class":null},"feeling_hot":{"text":{"zh":"热","en":"hot"},"css":{},"message_class":null},"feeling_cold":{"text":{"zh":"冷","en":"cold"},"css":{},"message_class":null},"attack_result_none":{"text":{"zh":"你没有打到任何东西。","en":"You attacked nothing."},"css":{"color":"#ffdddd"},"message_class":null},"attack_result_hardness":{"text":{"zh":"你打到了一个{hardness}物。","en":"You attacked a {hardness} thing."},"css":{"color":"#ffdddd"},"message_class":null},"damage_unknown":{"text":{"zh":"你受到了来自{dir}的{value}伤害。","en":"You got {value} damage from {dir}."},"css":{"color":"red"},"message_class":null},"damage_hit_hard":{"text":{"zh":"你受到了来自{dir}的{value}伤害。","en":"You got {value} damage from {dir}."},"css":{"color":"red"},"message_class":null},"damage_attack_hard":{"text":{"zh":"你的手打到了一个硬物，受到了{value}伤害。","en":"You attacked a hard thing and got {value} damage。"},"css":{"color":"red"},"message_class":null},"damage_lava":{"text":{"zh":"你掉入岩浆并受到{value}伤害。","en":"You drop into lava and got {value} damage."},"css":{"color":"red"},"message_class":null},"damage_thorns":{"text":{"zh":"你的手被扎了一下，受到了{value}伤害。","en":"You got {value} damage by thorns."},"css":{"color":"red"},"message_class":null},"damage_attack":{"text":{"zh":"你被来自{dir}的攻击伤到，受到了{value}伤害。","en":"You are hurted by attack from {dir} and got {value} damage."},"css":{"color":"red"},"message_class":null},"death_unknown":{"text":{"zh":"{death}不知为何死了。","en":"{death} just dead."},"css":{"color":"#bb0000"},"message_class":null},"death_hit_hard":{"text":{"zh":"{death}撞{damager}而死。","en":"{death} hit {damager} and dead."},"css":{"color":"#bb0000"},"message_class":null},"death_attack_hard":{"text":{"zh":"{death}重拳出击，但打到了{damager}。","en":"{death} is killed by {damager}."},"css":{"color":"#bb0000"},"message_class":null},"death_lava":{"text":{"zh":"{death}在岩浆中游泳。","en":"{death} swam in lava."},"css":{"color":"#bb0000"},"message_class":null},"death_thorns":{"text":{"zh":"{death}被荆棘扎死。","en":"{death} touch the thorns."},"css":{"color":"#bb0000"},"message_class":null},"death_attack":{"text":{"zh":"{death}被{damager}击杀。","en":"{death} is killed by {damager}"},"css":{"color":"#bb0000"},"message_class":null},"drop_coin":{"text":{"zh":"你丢失了{count}枚金币。","en":"You dropped {count} coin(s)."},"css":{"color":"#ff3300"},"message_class":null},"welcome":{"text":{"zh":"欢迎来到暮光原野！你现在可以移动和转身了。","en":"Welcome to Dark Wild! You can move and turn now."},"css":{"color":"cyan"},"message_class":null},"player_message":{"text":{"zh":"[{player}] {message}","en":"[{player}] {message}"},"css":{},"message_class":null},"message_error":{"text":{"zh":"发送消息时出现错误:{reason}。","en":"Error on message:{reason}."},"css":{"color":"red"},"message_class":null},"no_message":{"text":{"zh":"消息为空","en":"no message"},"css":{},"message_class":null},"join_error":{"text":{"zh":"加入失败:{reason}。","en":"Error on joining:{reason}."},"css":{"color":"red"},"message_class":null},"action_error":{"text":{"zh":"操作失败:{reason}。","en":"Error on action:{reason}."},"css":{"color":"red"},"message_class":null},"wrong_pair":{"text":{"zh":"玩家名和UUID不匹配({data})","en":"wrong player/uuid pair({data})"},"css":{},"message_class":null},"no_action":{"text":{"zh":"你不能做这个动作","en":"no such action"},"css":{},"message_class":null},"no_name":{"text":{"zh":"没传玩家名","en":"no name"},"css":{},"message_class":null},"same_name":{"text":{"zh":"玩家名已存在","en":"same name"},"css":{},"message_class":null},"no_space":{"text":{"zh":"地图没有空间","en":"no space"},"css":{},"message_class":null},"player_alive":{"text":{"zh":"玩家未死亡","en":"player is alive"},"css":{},"message_class":null},"north":{"text":{"zh":"北","en":"north"},"css":{},"message_class":null},"west":{"text":{"zh":"西","en":"west"},"css":{},"message_class":null},"south":{"text":{"zh":"南","en":"south"},"css":{},"message_class":null},"east":{"text":{"zh":"东","en":"east"},"css":{},"message_class":null},"long_long_string":{"text":{"zh":"一个非常长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长长的字符串。","en":"A very loooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooong string."},"css":{"color":"violet"},"message_class":null},"long_long_string2":{"text":{"zh":"一个非常 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 长 的字符串。","en":"A very l o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o o ng string."},"css":{},"message_class":null},"format_test":{"text":{"zh":"{a} + {b} = {sum}","en":"{a} + {b} = {sum}"},"css":{"color":"pink"},"message_class":null},"send_test":{"text":{"zh":"收到数据{action}。","en":"Got a data {action}."},"css":{"color":"blue"},"message_class":null},"mo_zzd":{"text":{"zh":"脚下的石板镌刻着神秘的花纹，有一股神秘的力量驱使着你去膜拜ZZD。","en":"You need to %ZZD!"},"css":{"color":"purple"},"message_class":null}};

var data={
	FORMAT_DATA,
	language:'zh',
	messages:[],
	name:'',
	health:'',
	coin:'',
	inputMessage:'',
};

var computed={
	life:function(){
		return this.health>0;
	},
	message_show:function(){
		return {
			[null]:true
		};
	},
	enable:function(){
		return {
			'go_forward':this.life,
			'go_backward':this.life,
			'turn_left':this.life,
			'turn_right':this.life,
			'touch_front':this.life,
			'touch_ground':this.life,
			'attack':this.life,
			'respawn':!this.life,
		};
	},
};

var methods={
	getText(id){
		return this.FORMAT_DATA[id].text[this.language];
	},
	getStyle(msg){
		var css=this.FORMAT_DATA[msg.format].css;
		return css||{};
	},
	msgShow(msg){
		return this.message_show[this.FORMAT_DATA[msg.format].message_class];
	},
	praseMessage(msg){
		if(typeof msg.format=='string'){
			var str=this.getText(msg.format);
			if(msg.data){
				var newData={};
				for(var i in msg.data){
					newData[i]=this.praseMessage(msg.data[i]);
				}
				str=str.format(newData);
			}
			return str;
		}else if(typeof msg=='string'){
			return msg;
		}else{
			return JSON.stringify(msg);
		}
	},
	sendSimpleAction(id){
		connector.send(id,{name:data.name,uuid:data.uuid});
	},
	sendMessage(){
		if(this.inputMessage!==''){
			connector.send('message',{name:data.name,uuid:data.uuid,message:this.inputMessage});
		}
		this.inputMessage='';
	},
	onKeyDown(e){
		var id=TABLE[String.fromCharCode(e.keyCode)];
		if(id&&this.enable[id]){
			this.sendSimpleAction(id);
		}
	},
}

var app = new Vue({
	el:'#app',
	data,
	computed,
	methods,
	created:function(){
		const app=this;
		window.onkeydown=function(event) {
			var e=event||window.event;
			app.onKeyDown.call(app,e);
		}
	},
	watch:{
		messages:function(){
			this.$nextTick(() => {
				const reponseElement = this.$el.querySelector("#reponse");
				reponseElement.scrollTop = reponseElement.scrollHeight;
			})
		}
	}
})

function onMessage(msg){
	if(msg instanceof Array){
		for(var i in msg){
			onMessage(msg[i]);
		}
		return;
	}
	switch(msg.format){
		case 'uuid_data':{
			data.uuid=msg.data.uuid;
			break;
		}
		case 'player_state':{
			for(let key of ['name','health','coin']){
				data[key]=msg.data[key];
			}
			break;
		}
		default:{
			// var onBottom=this.reponse.scrollTop()+this.reponse.height()+50>=this.reponse.prop("scrollHeight");
			data.messages.push(msg);
			// if(onBottom){
			// 	this.reponse.scrollTop(this.reponse.prop("scrollHeight"));
			// }
			break;
		}
	}
}

var connector=new Connector();
connector.connect(new Server());
connector.listen(onMessage);
connector.send('join',{name:'test'});

const TABLE={
	'W':'go_forward',
	'S':'go_backward',
	'A':'turn_left',
	'D':'turn_right',
	'E':'touch_front',
	'Q':'touch_ground',
	'F':'attack',
	'R':'respawn',
};

// const ops='wqawwwawedwwqfwdwwwewesdwawdwwwwqawdwawqefwqesawwwdwawe'.toUpperCase();
// console.log(ops);
// for(let op of [...ops]){
// 	app.onKey.call(app,{keyCode:op.charCodeAt(0)});
// }